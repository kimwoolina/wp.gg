<form id="articleForm" action="{% url 'articles' %}" method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    
    <!-- 1. 유저 검색 기능 -->
    <div>
        <input type="text" id="user-search" placeholder="Search for users by username or riot_username">
        <select id="reviewee" name="reviewee">
            <option value="">--평가 할 사람을 고르세요--</option>
        </select>
    </div>
    
    <!-- 2. 이미지 업로드 및 미리보기 -->
    <label for="img">Image</label>
    <input type="file" name="img" id="img" multiple accept="image/*" onchange="previewImages(event)">
    <div id="image-preview"></div>

    <!-- 3. title & content -->
    <label for="title">Title</label>
    <input type="text" name="title" id="title" required><br>
    
    <label for="content">Content</label>
    <input type="text" name="content" id="content" required><br>

    <!-- 4. 이모티콘 점수 선택 -->
    <label for="article_score">Score</label>
    <div id="emoji-score">
        <label>
            <input type="radio" name="article_score" value="10" required> 😍
        </label>
        <label>
            <input type="radio" name="article_score" value="9" required> 🥰
        </label>
        <label>
            <input type="radio" name="article_score" value="8" required> 😘
        </label>
        <label>
            <input type="radio" name="article_score" value="7" required> 😄
        </label>
        <label>
            <input type="radio" name="article_score" value="6" required> 😙
        </label>
        <label>
            <input type="radio" name="article_score" value="5" required> 🙂
        </label>
        <label>
            <input type="radio" name="article_score" value="4" required> 🥺
        </label>
        <label>
            <input type="radio" name="article_score" value="3" required> 😞
        </label>
        <label>
            <input type="radio" name="article_score" value="2" required> 😣
        </label>
        <label>
            <input type="radio" name="article_score" value="1" required> 😡
        </label>
        <label>
            <input type="radio" name="article_score" value="0" required> 🤮
        </label>
    </div>

    <!-- 5. 평가 항목들 -->
    <label> 평가 항목</label>
    <div>
    <input type="checkbox" id="kindness" value="1" name="kindness">
    <label for="kindness">Kindness</label>

    <input type="checkbox" id="teamwork" value="1" name="teamwork">
    <label for="teamwork">Teamwork</label>

    <input type="checkbox" id="communication" value="1" name="communication">
    <label for="communication">Communication</label>

    <input type="checkbox" id="mental_strength" value="1" name="mental_strength">
    <label for="mental_strength">Mental Strength</label>

    <input type="checkbox" id="punctuality" value="1" name="punctuality">
    <label for="punctuality">Punctuality</label>

    <input type="checkbox" id="positivity" value="1" name="positivity">
    <label for="positivity">Positivity</label>

    <input type="checkbox" id="mvp" value="1" name="mvp">
    <label for="mvp">MVP</label>

    <input type="checkbox" id="mechanical_skill" value="1" name="mechanical_skill">
    <label for="mechanical_skill">Mechanical Skill</label>

    <input type="checkbox" id="operation" value="1" name="operation">
    <label for="operation">Operation</label>

    <input type="checkbox" id="negativity" value="1" name="negativity">
    <label for="negativity">Negativity</label>

    <input type="checkbox" id="profanity" value="1" name="profanity">
    <label for="profanity">Profanity</label>

    <input type="checkbox" id="afk" value="1" name="afk">
    <label for="afk">AFK</label>

    <input type="checkbox" id="cheating" value="1" name="cheating">
    <label for="cheating">Cheating</label>

    <input type="checkbox" id="verbal_abuse" value="1" name="verbal_abuse">
    <label for="verbal_abuse">Verbal Abuse</label>
</div>

    <input type="submit" value="Save" />
</form>

<script>
    // Bearer 토큰 가져오는 함수
    function getAccessToken() {
        return localStorage.getItem('access_token');
    }
    
    // CSRF 토큰을 가져오는 함수
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');

    // 1. 유저 검색 기능
    document.getElementById('user-search').addEventListener('input', function (e) {
        const query = e.target.value;
        const revieweeSelect = document.getElementById('reviewee');
        revieweeSelect.innerHTML = '<option value="">--평가 할 사람을 고르세요--</option>'; // 초기 옵션 설정

        fetch(`/api/articles/search_user/?q=${query}`, {
            method: 'GET', 
            headers: {
                'X-CSRFToken': csrftoken, 
                'Authorization': 'Bearer ' + getAccessToken() 
            }
            })
            .then(response => response.json())
            .then(data => {
                if (data.users.length === 0) {
                    return; // 검색 결과가 없을 경우 종료
                }
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.textContent = `${user.username} | ${user.riot_username || ''}${user.riot_tag || ''}`;
                    option.value = user.id;
                    revieweeSelect.appendChild(option); // 선택 옵션에 추가
                });
            });
    });


    // 2. 이미지 미리보기 기능
    function previewImages(event) {
        const previewContainer = document.getElementById('image-preview');
        previewContainer.innerHTML = '';
        
        const files = event.target.files;
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const imgElement = document.createElement('img');
                imgElement.src = e.target.result;
                imgElement.style.maxWidth = '100px';
                imgElement.style.marginRight = '10px';
                previewContainer.appendChild(imgElement);
            };
            reader.readAsDataURL(file);
        });
    }

    // 폼 전송 시 Bearer 토큰을 함께 전송
    document.getElementById('articleForm').addEventListener('submit', function(event) {
        event.preventDefault(); // 기본 폼 제출 방지

        const form = event.target;
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Authorization': 'Bearer ' + getAccessToken() // Bearer 토큰 추가
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
            // 성공 시 처리할 로직
        })
        .catch(error => {
            console.error('Error:', error);
            // 실패 시 처리할 로직
        });
    });

</script>
