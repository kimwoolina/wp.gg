{% extends "base.html" %}
{% load static %}

{% block title %}리뷰 목록{% endblock title %}

{% block css %}
    <style>
        .article {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 10px;
            display: flex; /* Flexbox 사용하여 정렬 */
            align-items: center; /* 세로 정렬 */
        }
        .article-title {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .article-content {
            margin-left: 10px;
            color: #555;
        }
        .icon {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }
        .profile-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 10px;
        }
        .username {
            font-size: 14px;
            font-weight: bold;
        }
        .created-at {
            font-size: 12px;
            color: #777;
        }
    </style>
{% endblock css %}

{% block content %}
<div class="button-container">
    <button class="button-81" role="button" onclick="window.location.href='{% url 'article-create' %}'">리뷰 작성하기</button>
</div>

<div id="article-list"></div>
{% endblock content %}

{% block javascript %}
<script>
// API URL
const apiUrl = 'http://127.0.0.1:8000/api/articles/';

// DOM element for article list
const articleList = document.getElementById('article-list');

// Function to format the date as "YYYY.MM.DD" or "X days ago"
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays === 0) {
        const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
        if (diffHours === 0) {
            const diffMinutes = Math.floor(diffTime / (1000 * 60));
            return diffMinutes + " minutes ago";
        }
        return diffHours + " hours ago";
    } else if (diffDays < 7) {
        return diffDays + " days ago";
    } else {
        return date.toISOString().split('T')[0].replace(/-/g, '.');
    }
}

// Function to create and append an article to the DOM
function appendArticle(article) {
    const reviewer = article.reviewer;

    // Icons
    const thumbIcon = 'https://cdn-icons-png.flaticon.com/512/2954/2954893.png';
    const moreIcon = 'https://cdn-icons-png.flaticon.com/512/2954/2954827.png'; // 말줄임표 아이콘

    // Reviewer info
    const reviewerUsername = reviewer.riot_username ? reviewer.riot_username : reviewer.username;
    const reviewerProfileImage = reviewer.profile_image ? reviewer.profile_image : '{% static "img/default_profile_image.png" %}';

    // Truncated content
    const truncatedContent = article.content.length > 10 ? article.content.substring(0, 10) + '...' : article.content;

    // Create article element
    const articleElement = document.createElement('div');
    articleElement.classList.add('article');

    // Create article title
    articleElement.innerHTML = `
        <img src="${thumbIcon}" alt="Thumbs Up" class="icon">
        <img src="${moreIcon}" alt="More" class="icon">
        <img src="${reviewerProfileImage}" alt="Profile Image" class="profile-image">
        <div class="article-content">
            <div class="username">${reviewerUsername}</div>
            <div class="created-at">${formatDate(article.created_at)}</div>
        </div>
    `;

    // Append to the list
    articleList.appendChild(articleElement);
}

// Fetch articles from API
fetch(apiUrl)
    .then(response => response.json())
    .then(data => {
        data.forEach(article => {
            appendArticle(article);
        });
    })
    .catch(error => {
        console.error('Error fetching articles:', error);
    });
</script>
{% endblock javascript %}
