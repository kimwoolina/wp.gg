{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/chat.css' %}">
    
    <style>
        /* 전체 배경 색상 */
        body {
            background-color: #1E1E1E;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        /* 로고 이미지 */
        .logo {
            width: 150px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        /* 채팅 컨테이너 */
        .container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            height: 600px;
            border-radius: 15px;
            background-color: #1E1E1E;
            color: white;
            overflow: hidden;
            margin-right: 300px;
            margin-left: 10px
        }

        /* 사이드바 */
        .sidebar {
            width: 300px;
            background-color: transparent; 
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .sidebar h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }

        #chat-room-list {
            list-style: none;
            padding: 0;
            width: 100%;
        }

        #chat-room-list li {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #3A3A3A;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #chat-room-list li:hover {
            background-color: #4F4F4F;
        }

        /* 채팅 영역 */
        .chat-area {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-message {
            max-width: 60%;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
            display: inline-block;
            position: relative;
        }

        .sent {
            background-color: #716490;
            margin-left: auto;
            text-align: right;
        }

        .received {
            background-color: #4F4F4F;
        }

        .chat-message .time {
            font-size: 12px;
            position: absolute;
            bottom: -20px;
            right: 10px;
            color: #B0B0B0;
        }

        .chat-message.received .time {
            left: 10px;
            right: auto;
        }

        /* 메시지 입력 */
        .message-input {
            display: flex;
            align-items: center;
            border-radius: 10px;
            background-color: #3A3A3A;
            padding: 10px;
            margin-top: 20px;
        }

        .message-input input {
            flex-grow: 1;
            background-color: #3A3A3A;
            border: none;
            color: white;
            padding: 10px;
            border-radius: 10px;
            margin-right: 10px;
        }

        .message-input input:focus {
            outline: none;
        }

        .message-input button {
            background-color: #716490;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
        }

        .message-input button:hover {
            background-color: #8B72B1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <!-- 로고 이미지 추가 -->
            <img src="{% static 'img/wpgg_logo_v2.png' %}" alt="logo" class="logo" id="logo">
            <h2>Chat Rooms</h2>
            <ul id="chat-room-list"></ul>
            <input type="text" id="user2-id" placeholder="Enter user ID to create chat room">
            <button id="create-chat-room">Create Chat Room</button>
        </div>
        <div class="chat-area">
            <h2>Chat Messages</h2>
            <div id="chat-messages"></div>
            <div class="message-input">
                <input type="text" id="message-input" placeholder="Type your message...">
                <button id="send-message">Send</button>
            </div>
        </div>
    </div>
    
    <script>
        $(document).ready(function() {
            // 로고 클릭 시 홈 화면으로 리다이렉트
            $('#logo').click(function() {
                window.location.href = '/';  // 홈 화면 URL로 리다이렉트
            });

            loadChatRooms(); // 페이지 로드 시 채팅방 목록 로드
    
            let pollingInterval; // 폴링 인터벌 변수
    
            // 채팅방 선택 시 메시지 로드
            $(document).on('click', '.select-chat-room', function() {
                const roomId = $(this).data('room-id'); // 클릭한 채팅방 ID 가져오기

                // 모든 채팅방에서 selected 클래스 제거
                $('.select-chat-room').removeClass('selected');

                // 클릭한 채팅방에 selected 클래스 추가
                $(this).addClass('selected');

                loadMessages(roomId);
                startPolling(roomId); // 폴링 시작
            });
    
            // 메시지 전송
            $('#send-message').click(function() {
                const roomId = $('.select-chat-room.selected').data('room-id'); // 선택된 채팅방 ID
                const messageContent = $('#message-input').val();

                if (messageContent && roomId) {
                    sendMessage(roomId, messageContent);
                    $('#message-input').val(''); // 입력창 초기화
                } else {
                    alert("Please select a chat room and enter a message.");
                }
            });

            // 채팅방 생성 버튼 클릭 시 호출
            $('#create-chat-room').click(function() {
                const user2Id = $('#user2-id').val();
                if (user2Id) {
                    createChatRoom(user2Id);
                    $('#user2-id').val(''); // 입력창 초기화
                } else {
                    alert("Please enter a user ID.");
                }
            });
    
            // 폴링 시작 함수
            function startPolling(roomId) {
                if (pollingInterval) {
                    clearInterval(pollingInterval); // 기존 폴링 중지
                }
    
                // 일정 간격으로 메시지 로드
                pollingInterval = setInterval(function() {
                    loadMessages(roomId);
                }, 500); // 0.5초 간격으로 로드
            }
    
            // 사용자 인증 토큰을 로컬 저장소에서 가져옵니다.
            function getAccessToken() {
                return localStorage.getItem('access_token');
            }

            // CSRF 토큰 가져오기 (Django용)
            function getCsrfToken() {
                return $('input[name="csrfmiddlewaretoken"]').val(); // CSRF 토큰 가져오기
            }
    
            // 메시지 및 채팅방 로드 함수
            function loadChatRooms() {
                $.ajax({
                    url: '/api/chat/chatrooms/',
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + getAccessToken() },
                    success: function(data) {
                        $('#chat-room-list').empty();
                        data.forEach(function(room) {
                            $('#chat-room-list').append('<li>' + room.room_name + ' <button class="select-chat-room" data-room-id="' + room.id + '">Select</button></li>');
                        });
                    },
                    error: function(xhr) {
                        alert("Failed to load chat rooms. Error: " + xhr.responseText);
                    }
                });
            }
    
            // 선택한 채팅방의 메시지를 로드하는 함수
            function loadMessages(roomId) {
                $.ajax({
                    url: '/api/chat/private-chats/' + roomId + '/messages/',
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + getAccessToken() },
                    success: function(messages) {
                        $('#chat-messages').empty();
                        messages.forEach(function(message) {
                            $('#chat-messages').append('<p><strong>' + message.sender.username + ':</strong> ' + message.content + '</p>');
                        });
                        $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight); // 스크롤을 가장 아래로
                    },
                    error: function(xhr) {
                        alert("Failed to load messages. Error: " + xhr.responseText);
                    }
                });
            }
    
            // 메시지 전송 함수
            function sendMessage(roomId, content) {
                $.ajax({
                    url: '/api/chat/private-chats/' + roomId + '/messages/',
                    method: 'POST',
                    headers: { 
                        'Authorization': 'Bearer ' + getAccessToken(),
                        'X-CSRFToken': getCsrfToken() // CSRF 토큰 추가
                    },
                    contentType: 'application/json',
                    data: JSON.stringify({ room_id: roomId, content: content }), // room_id 사용
                    success: function(message) {
                        // 메시지 전송 후 아무 동작 없이 종료
                    },
                    error: function(xhr) {
                        alert("Failed to send message. Error: " + xhr.responseText);
                    }
                });
            }
    
            // 채팅방 생성 함수
            function createChatRoom(user2Id) {
                $.ajax({
                    url: '/api/chat/private-chat/',
                    method: 'POST',
                    headers: { 
                        'Authorization': 'Bearer ' + getAccessToken(),
                        'X-CSRFToken': getCsrfToken() // CSRF 토큰 추가
                    },
                    contentType: 'application/json',
                    data: JSON.stringify({ user2: user2Id }),
                    success: function(room) {
                        loadChatRooms(); // 새로운 채팅방 생성 후 목록 재로드
                    },
                    error: function(xhr) {
                        alert("Failed to create chat room. Error: " + xhr.responseText);
                    }
                });
            }
        });
    </script>
</body>
</html>
