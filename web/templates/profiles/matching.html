{% extends "base.html" %}
{% load static %}
{% block title %}나에게 꼭 맞는 유저찾기❤️{% endblock title %}

{% block css %}
<link rel="stylesheet" href="{% static '/css/matching.css' %}"> 
{% endblock css %}

{% block content %}

<form id="recommendation-form" action="{% url 'articles' %}" method="POST" enctype="multipart/form-data">

    {% csrf_token %}

    <form id="recommendation-form">
        {% csrf_token %}

        <div class="form-group">
            <div class="cute-dropdown">
                <select id="riot_tier" name="riot_tier">
                    <option value="" disabled selected>티어 선택</option>
                    <option value="bronze">브론즈</option>
                    <option value="silver">실버</option>
                    <option value="gold">골드</option>
                    <option value="platinum">플래티넘</option>
                    <option value="diamond">다이아몬드</option>
                    <option value="master">마스터</option>
                    <option value="grandmaster">그랜드마스터</option>
                    <option value="challenger">챌린저</option>
                </select>
            </div>
        
            <div class="cute-dropdown">
                <select id="riot_position" name="riot_position">
                    <option value="" disabled selected>포지션 선택</option>
                    <option value="top">탑</option>
                    <option value="jungle">정글</option>
                    <option value="mid">미드</option>
                    <option value="adc">원거리 딜러</option>
                    <option value="support">서포터</option>
                </select>
            </div>
        </div>


    <!-- 선호도 항목들 -->
    <div class="review-categories">
        <span class="badge" data-value="kindness">💗 상냥함</span>
        <span class="badge" data-value="teamwork">🛠 팀워크</span>
        <span class="badge" data-value="communication">📢 커뮤니케이션</span>
        <span class="badge" data-value="mental_strength">🧠 멘탈</span>
        <span class="badge" data-value="punctuality">⏰ 시간약속</span>
        <span class="badge" data-value="positivity">💪 긍정적</span>
        <span class="badge" data-value="mvp">⭐ MVP</span>
        <span class="badge" data-value="mechanical_skill">⚙️ 기계적</span>
        <span class="badge" data-value="operation">🎮 운영</span>
        <span class="badge" data-value="negativity">☹️ 부정적태도</span>
        <span class="badge" data-value="profanity">🤬 욕설</span>
        <span class="badge" data-value="afk">💤 탈주/자리비움</span>
        <span class="badge" data-value="cheating">🎮 치트</span>
        <span class="badge" data-value="verbal_abuse">😡 언어적폭력</span>
        <span class="badge" data-value="verbal_abuse">📌 기술</span>
        <span class="badge" data-value="verbal_abuse">🙈 피지컬</span>
        <span class="badge" data-value="verbal_abuse">🧍🏻 아들래미</span>
        <span class="badge" data-value="verbal_abuse">🧨 폭탄처리반</span>
        <span class="badge" data-value="verbal_abuse">🥰 목소리예쁨</span>
        <span class="badge" data-value="verbal_abuse">😂 웃김</span>
        <span class="badge" data-value="verbal_abuse">⛑️ 위기대처</span>
        <span class="badge" data-value="verbal_abuse">🤷🏻‍♂️ 목소리잘생김</span>
        <span class="badge" data-value="verbal_abuse">🙅‍♀️ 말예쁘게함</span>
    </div>

    <!-- 선호 스타일 -->
    <div class="form-group preference-group">
        <label for="user_preference" class="preference-label">선호하는 스타일 입력하기</label>
        <textarea id="content" name="content" class="content-box" placeholder="예: 목소리 예쁜 유저를 선호합니다.." required></textarea>
    </div>

    <input type="hidden" name="selected_categories" id="selected_categories">
    <input type="submit" value="❤️&nbsp나랑 맞는 유저 찾아줘&nbsp❤️" class="submit-btn">

    </form>

{% endblock content %}

{% block javascript%}

<script>
    // Bearer 토큰 가져오는 함수
    function getAccessToken() {
        return localStorage.getItem('access_token');
    }

    // CSRF 토큰을 가져오는 함수
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');

    // 선호하는 스타일 체크하기 기능
    document.addEventListener('DOMContentLoaded', function() {
        const badges = document.querySelectorAll('.badge');
        const selectedCategoriesInput = document.getElementById('selected_categories');

        badges.forEach(badge => {
            badge.addEventListener('click', function() {
                // 선택된 뱃지에 'selected' 클래스 추가/제거
                this.classList.toggle('selected');
    
                // 선택된 카테고리를 hidden input에 업데이트
                const selectedCategories = Array.from(badges)
                    .filter(badge => badge.classList.contains('selected'))
                    .map(badge => badge.dataset.value);
                selectedCategoriesInput.value = selectedCategories.join(',');
            });
        });
    });

    document.getElementById('recommendation-form').addEventListener('submit', function(event) {
        event.preventDefault(); // 폼 제출 기본 동작 방지

        // FormData 객체를 통해 폼 데이터를 수집
        const formData = new FormData(event.target);
        const params = new URLSearchParams(formData).toString(); // 쿼리 문자열로 변환

        // Fetch API로 GET 요청 보내기
        fetch('/api/profile/recommendation?' + params)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // 결과 표시
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = ''; // 이전 결과 초기화
                if (data.length > 0) {
                    const list = document.createElement('ul');
                    data.forEach(user => {
                        const listItem = document.createElement('li');
                        listItem.textContent = `${user.username} (티어: ${user.riot_tier}, 포지션: ${user.positions.join(', ')})`;
                        list.appendChild(listItem);
                    });
                    resultDiv.appendChild(list);
                    // 매칭 결과 페이지로 리다이렉트
                    window.location.href = '/matching_result/';
                } else {
                    resultDiv.textContent = '추천된 유저가 없습니다.';
                }
            })
            .catch(error => {
                console.error('Error fetching recommendations:', error);
            });
    });

</script>

{% endblock javascript %}
