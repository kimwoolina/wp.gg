{% extends "base.html" %}
{% load static %}
{% block title %}ë‚˜ì—ê²Œ ê¼­ ë§ëŠ” ìœ ì €ì°¾ê¸°â¤ï¸{% endblock title %}

{% block css %}
<link rel="stylesheet" href="{% static '/css/matching.css' %}"> 
{% endblock css %}

{% block content %}

<form id="recommendation-form" action="{% url 'articles' %}" method="POST" enctype="multipart/form-data">

    {% csrf_token %}

    <form id="recommendation-form">
        {% csrf_token %}

        <div class="form-group">
            <div class="cute-dropdown">
                <select id="riot_tier" name="riot_tier">
                    <option value="" disabled selected>í‹°ì–´ ì„ íƒ</option>
                    <option value="bronze">ë¸Œë¡ ì¦ˆ</option>
                    <option value="silver">ì‹¤ë²„</option>
                    <option value="gold">ê³¨ë“œ</option>
                    <option value="platinum">í”Œë˜í‹°ë„˜</option>
                    <option value="diamond">ë‹¤ì´ì•„ëª¬ë“œ</option>
                    <option value="master">ë§ˆìŠ¤í„°</option>
                    <option value="grandmaster">ê·¸ëœë“œë§ˆìŠ¤í„°</option>
                    <option value="challenger">ì±Œë¦°ì €</option>
                </select>
            </div>
        
            <div class="cute-dropdown">
                <select id="riot_position" name="riot_position">
                    <option value="" disabled selected>í¬ì§€ì…˜ ì„ íƒ</option>
                    <option value="top">íƒ‘</option>
                    <option value="jungle">ì •ê¸€</option>
                    <option value="mid">ë¯¸ë“œ</option>
                    <option value="adc">ì›ê±°ë¦¬ ë”œëŸ¬</option>
                    <option value="support">ì„œí¬í„°</option>
                </select>
            </div>
        </div>


    <!-- ì„ í˜¸ë„ í•­ëª©ë“¤ -->
    <div class="review-categories">
        <span class="badge" data-value="kindness">ğŸ’— ìƒëƒ¥í•¨</span>
        <span class="badge" data-value="teamwork">ğŸ›  íŒ€ì›Œí¬</span>
        <span class="badge" data-value="communication">ğŸ“¢ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜</span>
        <span class="badge" data-value="mental_strength">ğŸ§  ë©˜íƒˆ</span>
        <span class="badge" data-value="punctuality">â° ì‹œê°„ì•½ì†</span>
        <span class="badge" data-value="positivity">ğŸ’ª ê¸ì •ì </span>
        <span class="badge" data-value="mvp">â­ MVP</span>
        <span class="badge" data-value="mechanical_skill">âš™ï¸ ê¸°ê³„ì </span>
        <span class="badge" data-value="operation">ğŸ® ìš´ì˜</span>
        <span class="badge" data-value="negativity">â˜¹ï¸ ë¶€ì •ì íƒœë„</span>
        <span class="badge" data-value="profanity">ğŸ¤¬ ìš•ì„¤</span>
        <span class="badge" data-value="afk">ğŸ’¤ íƒˆì£¼/ìë¦¬ë¹„ì›€</span>
        <span class="badge" data-value="cheating">ğŸ® ì¹˜íŠ¸</span>
        <span class="badge" data-value="verbal_abuse">ğŸ˜¡ ì–¸ì–´ì í­ë ¥</span>
        <span class="badge" data-value="verbal_abuse">ğŸ“Œ ê¸°ìˆ </span>
        <span class="badge" data-value="verbal_abuse">ğŸ™ˆ í”¼ì§€ì»¬</span>
        <span class="badge" data-value="verbal_abuse">ğŸ§ğŸ» ì•„ë“¤ë˜ë¯¸</span>
        <span class="badge" data-value="verbal_abuse">ğŸ§¨ í­íƒ„ì²˜ë¦¬ë°˜</span>
        <span class="badge" data-value="verbal_abuse">ğŸ¥° ëª©ì†Œë¦¬ì˜ˆì¨</span>
        <span class="badge" data-value="verbal_abuse">ğŸ˜‚ ì›ƒê¹€</span>
        <span class="badge" data-value="verbal_abuse">â›‘ï¸ ìœ„ê¸°ëŒ€ì²˜</span>
        <span class="badge" data-value="verbal_abuse">ğŸ¤·ğŸ»â€â™‚ï¸ ëª©ì†Œë¦¬ì˜ìƒê¹€</span>
        <span class="badge" data-value="verbal_abuse">ğŸ™…â€â™€ï¸ ë§ì˜ˆì˜ê²Œí•¨</span>
    </div>

    <!-- ì„ í˜¸ ìŠ¤íƒ€ì¼ -->
    <div class="form-group preference-group">
        <label for="user_preference" class="preference-label">ì„ í˜¸í•˜ëŠ” ìŠ¤íƒ€ì¼ ì…ë ¥í•˜ê¸°</label>
        <textarea id="content" name="content" class="content-box" placeholder="ì˜ˆ: ëª©ì†Œë¦¬ ì˜ˆìœ ìœ ì €ë¥¼ ì„ í˜¸í•©ë‹ˆë‹¤.." required></textarea>
    </div>

    <input type="hidden" name="selected_categories" id="selected_categories">
    <input type="submit" value="â¤ï¸&nbspë‚˜ë‘ ë§ëŠ” ìœ ì € ì°¾ì•„ì¤˜&nbspâ¤ï¸" class="submit-btn">

    </form>

{% endblock content %}

{% block javascript%}

<script>
    // Bearer í† í° ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getAccessToken() {
        return localStorage.getItem('access_token');
    }

    // CSRF í† í°ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');

    // ì„ í˜¸í•˜ëŠ” ìŠ¤íƒ€ì¼ ì²´í¬í•˜ê¸° ê¸°ëŠ¥
    document.addEventListener('DOMContentLoaded', function() {
        const badges = document.querySelectorAll('.badge');
        const selectedCategoriesInput = document.getElementById('selected_categories');

        badges.forEach(badge => {
            badge.addEventListener('click', function() {
                // ì„ íƒëœ ë±ƒì§€ì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€/ì œê±°
                this.classList.toggle('selected');
    
                // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë¥¼ hidden inputì— ì—…ë°ì´íŠ¸
                const selectedCategories = Array.from(badges)
                    .filter(badge => badge.classList.contains('selected'))
                    .map(badge => badge.dataset.value);
                selectedCategoriesInput.value = selectedCategories.join(',');
            });
        });
    });

    document.getElementById('recommendation-form').addEventListener('submit', function(event) {
        event.preventDefault(); // í¼ ì œì¶œ ê¸°ë³¸ ë™ì‘ ë°©ì§€

        // FormData ê°ì²´ë¥¼ í†µí•´ í¼ ë°ì´í„°ë¥¼ ìˆ˜ì§‘
        const formData = new FormData(event.target);
        const params = new URLSearchParams(formData).toString(); // ì¿¼ë¦¬ ë¬¸ìì—´ë¡œ ë³€í™˜

        // Fetch APIë¡œ GET ìš”ì²­ ë³´ë‚´ê¸°
        fetch('/api/profile/recommendation?' + params)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // ê²°ê³¼ í‘œì‹œ
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = ''; // ì´ì „ ê²°ê³¼ ì´ˆê¸°í™”
                if (data.length > 0) {
                    const list = document.createElement('ul');
                    data.forEach(user => {
                        const listItem = document.createElement('li');
                        listItem.textContent = `${user.username} (í‹°ì–´: ${user.riot_tier}, í¬ì§€ì…˜: ${user.positions.join(', ')})`;
                        list.appendChild(listItem);
                    });
                    resultDiv.appendChild(list);
                    // ë§¤ì¹­ ê²°ê³¼ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    window.location.href = '/matching_result/';
                } else {
                    resultDiv.textContent = 'ì¶”ì²œëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.';
                }
            })
            .catch(error => {
                console.error('Error fetching recommendations:', error);
            });
    });

</script>

{% endblock javascript %}
