{% extends "base.html" %}

{% block title %}ë¦¬ë·° ì‘ì„±{% endblock title %}

{% block css %}
    <style>
        /* ì „ì²´ ë°°ê²½ìƒ‰ */
        body {
            background-color: #1E1E1E;
            color: #fff;
        }
        
        /* ìœ ì € ê²€ìƒ‰ ìƒì */
        .user-search-container {
            position: relative;
            margin: 0 auto 0;
            width: 45%;
        }
        
        .reviewee-select {
            -webkit-appearance: none; /* ì‚¬íŒŒë¦¬ ë¸Œë¼ìš°ì € */
            -moz-appearance: none; /* íŒŒì´ì–´í­ìŠ¤ */
            appearance: none; /* ëª¨ë“  ë¸Œë¼ìš°ì € */
            width: 152px;
            padding: 10px;
            border-radius: 13px;
            background-color: #333;
            color: #deddec;
            margin-top: 34px;
            font-size: 14px;
            margin-left: 5px;
            margin-right: 8px;
            border: transparent;
        }

        /* ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ì— ì»¤ìŠ¤í…€ í™”ì‚´í‘œ íš¨ê³¼ ì—†ì• ê¸° */
        .reviewee-select::after {
            display: none; /* ê¸°ë³¸ í™”ì‚´í‘œë¥¼ ì™„ì „íˆ ì œê±° */
        }

        /* í˜¸ë²„ ìŠ¤íƒ€ì¼ */
        .reviewee-select:hover {
            background-color: #444;
        }

        
        /* ì´ëª¨í‹°ì½˜ ì ìˆ˜ ì„ íƒ */
        .emoji-score label {
            font-size: 50px;
            margin-right: 15px;
            cursor: pointer;
            margin-bottom: 30px;
        }
        
        /* ë¦¬ë·° ë‚´ìš© */
        .content-box {
            width: 91%;
            height: 100px;
            border-radius: 15px;
            background-color: #333;
            color: #dbe1ff;
            border: none;
            padding: 10px;
            padding: 16px;
            font-size: 16px;
            margin-top: 29px;
        }
        
  /* í‰ê°€ í•­ëª© ìŠ¤íƒ€ì¼ */
        .review-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .review-categories label {
            background-color: #444;
            padding: 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* ì œì¶œ ë²„íŠ¼ */
        .submit-btn {
            margin-top: 40px;
            padding: 8px 17px;
            background-color: #716490;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 800px;
        }
        
        .submit-btn:hover {
            background-color: #8B72B1;
        }
        
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background-color: #1e1e1e;
        }
        
        .tag-label {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 7px 10px;
            border-radius: 25px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
        }
        
        .tag-label input {
            display: none;
        }
        
        .tag-label span {
            margin-left: 8px;
            font-weight: bold;
            color: black;
        }
        
        .tag-label:hover {
            background-color: #f0f0f0;
            border-color: #716490; /* Hover border color */
        }
        
        .tag-label input:checked + span {
            background-color: #6f69a5; /* Checked background color */
            color: white;
            padding: 5px 10px;
            border-radius: 25px;
            transition: background-color 0.3s ease;
        }
        
        .review-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 11px;
            padding: 20px;
        }
        
        .review-categories .badge {
            background-color: #fdfdfd;
            color: #31273d;
            padding: 4px 10px;
            border-radius: 14px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            display: inline-block;
        }
        
        .review-categories .badge:hover {
            background-color: #f0f0f0;
            border: 3px solid #119c77;
            color: #119c77;
        }
        
        .review-categories .badge.selected {
            background-color: #6d618b;
            color: #e3d8ff;
            border: 2px solid transparent #119c77;
            glow: 2;
        }
        
        /* ì œì¶œ ë²„íŠ¼ */
        .submit-btn {
            margin-top: 40px;
            padding: 8px 17px;
            background-color: #716490;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 800px;
        }
        
        .submit-btn:hover {
            background-color: #8B72B1;
        }
        
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background-color: #1e1e1e;
        }
        
        .tag-label {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 7px 10px;
            border-radius: 25px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
        }
        
        .tag-label input {
            display: none;
        }
        
        .tag-label span {
            margin-left: 8px;
            font-weight: bold;
            color: black;
        }
        
        .tag-label:hover {
            background-color: #f0f0f0;
            border-color: #716490; /* Hover border color */
        }
        
        .tag-label input:checked + span {
            background-color: #6f69a5; /* Checked background color */
            color: white;
            padding: 5px 10px;
            border-radius: 25px;
            transition: background-color 0.3s ease;
        }
        
        .review-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 11px;
            padding: 20px;
        }
        
        .review-categories .badge {
            background-color: #fdfdfd;
            color: #31273d;
            padding: 4px 10px;
            border-radius: 14px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            display: inline-block;
        }
        
        .review-categories .badge:hover {
            background-color: #f0f0f0;
            border: 3px solid #119c77;
            color: #119c77;
        }
        
        .review-categories .badge.selected {
            background-color: #6d618b;
            color: #e3d8ff;
            border: 2px solid transparent #119c77;
            glow: 2;
        }

        /* ë‹ë³´ê¸° ì•„ì´ì½˜ */
        .search-btn {
            position: absolute;
            right: 16%;
            top: 25%;
            /* transform: translateY(-50%); */
            width: 20px;
            height: 24px;
            cursor: pointer;
        }
        
        .search-btn:hover {
            fill: #8B72B1; /* í˜¸ë²„ ì‹œ ìƒ‰ìƒ ë³€ê²½ */
        }
        
        .search-bar {
            padding: 16px;
            border-radius: 19px;
            background-color: #464646;
            max-width: 1400px;
            border: none;
            color: #fff;
            margin: 30px 17% 30px auto;
            width: 70%;
        }

        /* ë¼ë””ì˜¤ ë²„íŠ¼ê³¼ ì´ëª¨í‹°ì½˜ì˜ ì»¨í…Œì´ë„ˆ */
        .emoji-radio-container {
            display: flex;
            justify-content: space-evenly;
            margin-top: 37px;
            margin-right: 12px;
            margin-left: -30px;
        }
    
        /* ì´ëª¨í‹°ì½˜ ìŠ¤íƒ€ì¼ */
        .emoji-label {
            font-size: 50px;
            display: block;
            text-align: center;
            margin-bottom: 10px;
        }
    
        /* ë¼ë””ì˜¤ ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .emoji-radio {
            display: block;
            margin: 0 auto;
            appearance: none; /* ê¸°ë³¸ ë¼ë””ì˜¤ ë²„íŠ¼ ìˆ¨ê¹€ */
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid #f09eff;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
    
        /* ë¼ë””ì˜¤ ë²„íŠ¼ ì²´í¬ì‹œ ë³´ë¼ìƒ‰ìœ¼ë¡œ ì±„ìš°ê¸° */
        .emoji-radio:checked {
            background-color: #fff;
        }
    
        /* ì„ íƒëœ ìƒíƒœì—ì„œì˜ ë‚´ë¶€ ë™ê·¸ë¼ë¯¸ */
        .emoji-radio:checked::after {
            content: '';
            width: 20px;
            height: 20px;
            background-color: #6d4094;
            border-radius: 100%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            glow: 1;
    }

    /* í‹°ì–´, í¬ì§€ì…˜ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    .cute-dropdown {
        position: relative;
        display: inline-block;
        width: 150px; /* ë“œë¡­ë‹¤ìš´ ë„ˆë¹„ ì¡°ì • */
        max-width: 200px;
        margin: 0 -30px; /* ë“œë¡­ë‹¤ìš´ ê°„ê²© */
        margin-left: 10px;
    }

    /* ê¸°ë³¸ í™”ì‚´í‘œ ì œê±° ë° ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ì ìš© */
    .cute-dropdown select {
        -webkit-appearance: none; /* ì‚¬íŒŒë¦¬ìš© */
        -moz-appearance: none; /* íŒŒì´ì–´í­ìŠ¤ìš© */
        appearance: none; /* ëª¨ë“  ë¸Œë¼ìš°ì €ì—ì„œ ê¸°ë³¸ í™”ì‚´í‘œ ì œê±° */
        width: 80%;
        padding: 16px 15px; /* íŒ¨ë”©ì„ ë” ë„“ê²Œ */
        font-size: 16px; /* ê¸€ì í¬ê¸° ì¡°ì • */
        font-weight: bold; /* ê¸€ì êµµê¸° */
        border: none; /* í…Œë‘ë¦¬ ì—†ì• ê¸° */
        border-radius: 15px; /* ë‘¥ê·¼ í…Œë‘ë¦¬ */
        background-color: #281b37; /* ì–´ë‘ìš´ ë°°ê²½ìƒ‰ */
        color: #f3f2f6; /* ë°ì€ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        text-align: center; /* ê°€ìš´ë° ì •ë ¬ */
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.1); /* ê·¸ë¦¼ì íš¨ê³¼ */
        cursor: pointer;
    }

    .cute-dropdown select:hover {
        background-color: #49239E; /* í˜¸ë²„ ì‹œ ë°°ê²½ìƒ‰ ë³€ê²½ */
        glow: 1;
    }

    .cute-dropdown select:focus {
        outline: none;
        border-color: #8B72B1;
        box-shadow: 0 0 5px rgba(139, 114, 177, 0.5);
    }

    /* í‹°ì–´, í¬ì§€ì…˜ */
    .form-group {
        display: block;
        text-align: left;
    }

    .left-body {
        display: flex;
        width: 100%;
        margin-right: 0px;
        margin-top: 0px;
    }

    .review-categories {
        gap: 14px;
        padding: 16px;
        margin-right: 50px;
    }

    .submit-btn {
        margin: 28px auto;
        /* margin-top: 40px; */
        padding: 11px 17px;
        background-color: #716490;
        color: white;
        border: none;
        border-radius: 22px;
        cursor: pointer;
        font-size: 15px;
        /* margin-left: 400px; */
    }

    /* ì„ í˜¸ ìŠ¤íƒ€ì¼ ì…ë ¥ ì˜ì—­ ìŠ¤íƒ€ì¼ */
    .preference-group {
        display: block;
        margin-top: 28px;
        margin-left: 10px;
    }

    .content-box {
        width: 100%;
        height: 120px;
        border-radius: 20px;
        background-color: #333;
        color: #dbe1ff;
        font-size: 17px;
        padding: 15px;
        border: none;
        resize: none;
        max-width: 1122px;
    }

    .preference-label {
        display: block;
        font-size: 18px;
        margin-bottom: -15px;
        margin-left: 16px;
        color: #b0b0b1;
    }

    submit-btn {
        margin-top: 40px;
        padding: 11px 17px;
        background-color: #716490;
        color: white;
        border: none;
        border-radius: 22px;
        cursor: pointer;
        font-size: 15px;
        align-content: center;
    }
    .search-bar {
        padding: 16px;
        border-radius: 19px;
        background-color: #464646;
        max-width: 1400px;
        border: none;
        color: #fff;
        margin: 30px auto 30px;
        width: 70%;
        align-content: center;
    }

    .left-container {
        width: 100%;
        margin-top: -10px;
        margin-bottom: 50px;
        margin-left: 90px;
        margin-right: 80px;
        text-align: center;
    }


</style>

{% endblock css %}

{% block content %}

<form id="articleForm" action="{% url 'articles' %}" method="POST" enctype="multipart/form-data">

    <!-- 1. ìœ ì € ê²€ìƒ‰ ê¸°ëŠ¥ -->
    <div class="user-search-container">
        <input type="text" id="user-search" class="search-bar" placeholder="ìœ ì € ê²€ìƒ‰">
        <svg id="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="search-btn" fill="white">
            <path d="M10 2a8 8 0 105.29 14.29l4.63 4.63 1.41-1.41-4.63-4.63A8 8 0 0010 2zm0 2a6 6 0 110 12 6 6 0 010-12z"/>
        </svg>
    </div>
    

    {% csrf_token %}

    <form id="recommendation-form">
        {% csrf_token %}

        <div class="form-group">
            <div class="cute-dropdown">
                <select id="riot_tier" name="riot_tier">
                    <option value="" disabled selected>í‹°ì–´ ì„ íƒ</option>
                    <option value="bronze">ë¸Œë¡ ì¦ˆ</option>
                    <option value="silver">ì‹¤ë²„</option>
                    <option value="gold">ê³¨ë“œ</option>
                    <option value="platinum">í”Œë˜í‹°ë„˜</option>
                    <option value="diamond">ë‹¤ì´ì•„ëª¬ë“œ</option>
                    <option value="master">ë§ˆìŠ¤í„°</option>
                    <option value="grandmaster">ê·¸ëœë“œë§ˆìŠ¤í„°</option>
                    <option value="challenger">ì±Œë¦°ì €</option>
                </select>
            </div>
        
            <div class="cute-dropdown">
                <select id="riot_position" name="riot_position">
                    <option value="" disabled selected>í¬ì§€ì…˜ ì„ íƒ</option>
                    <option value="top">íƒ‘</option>
                    <option value="jungle">ì •ê¸€</option>
                    <option value="mid">ë¯¸ë“œ</option>
                    <option value="adc">ì›ê±°ë¦¬ ë”œëŸ¬</option>
                    <option value="support">ì„œí¬í„°</option>
                </select>
            </div>
        </div>



    <!-- ì„ í˜¸ë„ í•­ëª©ë“¤ -->
    <div class="review-categories">
        <span class="badge" data-value="kindness">ğŸ’— ìƒëƒ¥í•¨</span>
        <span class="badge" data-value="teamwork">ğŸ›  íŒ€ì›Œí¬</span>
        <span class="badge" data-value="communication">ğŸ“¢ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜</span>
        <span class="badge" data-value="mental_strength">ğŸ§  ë©˜íƒˆ</span>
        <span class="badge" data-value="punctuality">â° ì‹œê°„ì•½ì†</span>
        <span class="badge" data-value="positivity">ğŸ’ª ê¸ì •ì </span>
        <span class="badge" data-value="mvp">â­ MVP</span>
        <span class="badge" data-value="mechanical_skill">âš™ï¸ ê¸°ê³„ì </span>
        <span class="badge" data-value="operation">ğŸ® ìš´ì˜</span>
        <span class="badge" data-value="negativity">â˜¹ï¸ ë¶€ì •ì íƒœë„</span>
        <span class="badge" data-value="profanity">ğŸ¤¬ ìš•ì„¤</span>
        <span class="badge" data-value="afk">ğŸ’¤ íƒˆì£¼/ìë¦¬ë¹„ì›€</span>
        <span class="badge" data-value="cheating">ğŸ® ì¹˜íŠ¸</span>
        <span class="badge" data-value="verbal_abuse">ğŸ˜¡ ì–¸ì–´ì í­ë ¥</span>
        <span class="badge" data-value="verbal_abuse">ğŸ“Œ ê¸°ìˆ </span>
        <span class="badge" data-value="verbal_abuse">ğŸ™ˆ í”¼ì§€ì»¬</span>
        <span class="badge" data-value="verbal_abuse">ğŸ§ğŸ» ì•„ë“¤ë˜ë¯¸</span>
        <span class="badge" data-value="verbal_abuse">ğŸ§¨ í­íƒ„ì²˜ë¦¬ë°˜</span>
        <span class="badge" data-value="verbal_abuse">ğŸ¥° ëª©ì†Œë¦¬ì˜ˆì¨</span>
        <span class="badge" data-value="verbal_abuse">ğŸ˜‚ ì›ƒê¹€</span>
        <span class="badge" data-value="verbal_abuse">â›‘ï¸ ìœ„ê¸°ëŒ€ì²˜</span>
        <span class="badge" data-value="verbal_abuse">ğŸ¤·ğŸ»â€â™‚ï¸ ëª©ì†Œë¦¬ì˜ìƒê¹€</span>
        <span class="badge" data-value="verbal_abuse">ğŸ™…â€â™€ï¸ ë§ì˜ˆì¨ê²Œí•¨</span>
    </div>
  
    <!-- ì„ í˜¸ ìŠ¤íƒ€ì¼ -->
    <div class="form-group preference-group">
        <label for="user_preference" class="preference-label">ì„ í˜¸í•˜ëŠ” ìŠ¤íƒ€ì¼ ì…ë ¥í•˜ê¸°</label>
        <textarea id="content" name="content" class="content-box" placeholder="ì˜ˆ: ëª©ì†Œë¦¬ ì˜ˆìœ ìœ ì €ë¥¼ ì„ í˜¸í•©ë‹ˆë‹¤.." required></textarea>
    </div>

    <input type="hidden" name="selected_categories" id="selected_categories">
    <input type="submit" value="â¤ï¸&nbspë‚˜ë‘ ë§ëŠ” ìœ ì € ì°¾ì•„ì¤˜&nbspâ¤ï¸" class="submit-btn">

    </form>

{% endblock content %}

{% block javascript%}

<script>


    // 1. ìœ ì € ê²€ìƒ‰ ê¸°ëŠ¥
    document.getElementById('search-icon').addEventListener('click', function () {
        const query = document.getElementById('user-search').value.trim(); // ê²€ìƒ‰ì–´ íŠ¸ë¦¼ ì²˜ë¦¬

        if (!query) {
            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        fetch(`/api/articles/search_user/?q=${encodeURIComponent(query)}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'Authorization': 'Bearer ' + getAccessToken(), // ì˜¬ë°”ë¥¸ í† í° ì „ë‹¬
            },
        })
            .then((response) => {
                if (response.status === 401) {
                    alert('ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    window.location.href = '/login'; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    return;
                }
                return response.json();
            })
            .then((data) => {
                if (data && data.users.length === 1) {
                    const user = data.users[0];
                    window.location.href = `/${user.username}`; // ìœ ì € ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
                } else {
                    alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            })
            .catch((error) => console.error('Error:', error));
    });

    
    // Bearer í† í° ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getAccessToken() {
        return localStorage.getItem('access_token');
    }

    // CSRF í† í°ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');


    // 1. ìœ ì € ê²€ìƒ‰ ê¸°ëŠ¥
    document.getElementById('search-icon').addEventListener('click', function() {
        const query = document.getElementById('user-search').value;
        const revieweeSelect = document.getElementById('reviewee');
        revieweeSelect.innerHTML = '<option value="">--í‰ê°€ í•  ì‚¬ëŒì„ ê³ ë¥´ì„¸ìš”--</option>';

        fetch(`/api/articles/search_user/?q=${query}`, {
            method: 'GET', 
            headers: {
                'X-CSRFToken': csrftoken, 
                'Authorization': 'Bearer ' + getAccessToken() 
            }
            })
            .then(response => response.json())
            .then(data => {
                if (data.users.length === 0) {
                    return;
                }
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.textContent = `${user.username} | ${user.riot_username || ''}${user.riot_tag || ''}`;
                    option.value = user.id;
                    revieweeSelect.appendChild(option);
                });
            });
    });


    // ì„ í˜¸í•˜ëŠ” ìŠ¤íƒ€ì¼ ì²´í¬í•˜ê¸° ê¸°ëŠ¥
    document.addEventListener('DOMContentLoaded', function() {
        const badges = document.querySelectorAll('.badge');
        const selectedCategoriesInput = document.getElementById('selected_categories');

        badges.forEach(badge => {
            badge.addEventListener('click', function() {
                // ì„ íƒëœ ë±ƒì§€ì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€/ì œê±°
                this.classList.toggle('selected');
    
                // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë¥¼ hidden inputì— ì—…ë°ì´íŠ¸
                const selectedCategories = Array.from(badges)
                    .filter(badge => badge.classList.contains('selected'))
                    .map(badge => badge.dataset.value);
                selectedCategoriesInput.value = selectedCategories.join(',');
            });
        });
    });


    document.getElementById('articleForm').addEventListener('submit', function (event) {
        event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë™ì‘ ë§‰ê¸°
    
        const revieweeSelect = document.getElementById('reviewee');
        const selectedCategories = document.getElementById('selected_categories').value;
    
        // ì¡°ê±´: ìµœì†Œí•œ í•˜ë‚˜ì˜ í‰ê°€ ëŒ€ìƒì´ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸ (í•„ìš” ì‹œ ìˆ˜ì •)
        if (revieweeSelect && revieweeSelect.value === "") {
            alert("ì„ í˜¸í•˜ëŠ” ê²Œì„ ìŠ¤íƒ€ì¼ì´ë‚˜ ì„ í˜¸í•˜ëŠ” ìœ ì €ì˜ ì„±ê²©ì„ ì„ íƒí•´ì£¼ì„¸ìš”ğŸ’“"); // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
            return;
        }
    
        // ë§¤ì¹­ ê²°ê³¼ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        window.location.href = '/matching_result/';
    });
    
</script>

{% endblock javascript %}
