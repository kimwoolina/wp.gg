{% extends "base.html" %}

{% block title %}리뷰 작성{% endblock title %}

{% block css %}
    <style>
        /* 전체 배경색 */
        body {
            background-color: #1E1E1E;
            color: #fff;
        }
        
        /* 유저 검색 상자 */
        .user-search-container {
            position: relative;
            margin: 0 auto 0;
            width: 45%;
        }
        
        .reviewee-select {
            -webkit-appearance: none; /* 사파리 브라우저 */
            -moz-appearance: none; /* 파이어폭스 */
            appearance: none; /* 모든 브라우저 */
            width: 152px;
            padding: 10px;
            border-radius: 13px;
            background-color: #333;
            color: #deddec;
            margin-top: 34px;
            font-size: 14px;
            margin-left: 5px;
            margin-right: 8px;
            border: transparent;
        }

        /* 드롭다운 버튼에 커스텀 화살표 효과 없애기 */
        .reviewee-select::after {
            display: none; /* 기본 화살표를 완전히 제거 */
        }

        /* 호버 스타일 */
        .reviewee-select:hover {
            background-color: #444;
        }

        
        /* 이모티콘 점수 선택 */
        .emoji-score label {
            font-size: 50px;
            margin-right: 15px;
            cursor: pointer;
            margin-bottom: 30px;
        }
        
        /* 리뷰 내용 */
        .content-box {
            width: 91%;
            height: 100px;
            border-radius: 15px;
            background-color: #333;
            color: #dbe1ff;
            border: none;
            padding: 10px;
            padding: 16px;
            font-size: 16px;
            margin-top: 29px;
        }
        
  /* 평가 항목 스타일 */
        .review-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .review-categories label {
            background-color: #444;
            padding: 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* 제출 버튼 */
        .submit-btn {
            margin-top: 40px;
            padding: 8px 17px;
            background-color: #716490;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 800px;
        }
        
        .submit-btn:hover {
            background-color: #8B72B1;
        }
        
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background-color: #1e1e1e;
        }
        
        .tag-label {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 7px 10px;
            border-radius: 25px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
        }
        
        .tag-label input {
            display: none;
        }
        
        .tag-label span {
            margin-left: 8px;
            font-weight: bold;
            color: black;
        }
        
        .tag-label:hover {
            background-color: #f0f0f0;
            border-color: #716490; /* Hover border color */
        }
        
        .tag-label input:checked + span {
            background-color: #6f69a5; /* Checked background color */
            color: white;
            padding: 5px 10px;
            border-radius: 25px;
            transition: background-color 0.3s ease;
        }
        
        .review-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 11px;
            padding: 20px;
        }
        
        .review-categories .badge {
            background-color: #fdfdfd;
            color: #31273d;
            padding: 4px 10px;
            border-radius: 14px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            display: inline-block;
        }
        
        .review-categories .badge:hover {
            background-color: #f0f0f0;
            border: 3px solid #119c77;
            color: #119c77;
        }
        
        .review-categories .badge.selected {
            background-color: #6d618b;
            color: #e3d8ff;
            border: 2px solid transparent #119c77;
            glow: 2;
        }
        
        /* 제출 버튼 */
        .submit-btn {
            margin-top: 40px;
            padding: 8px 17px;
            background-color: #716490;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 800px;
        }
        
        .submit-btn:hover {
            background-color: #8B72B1;
        }
        
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background-color: #1e1e1e;
        }
        
        .tag-label {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 7px 10px;
            border-radius: 25px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
        }
        
        .tag-label input {
            display: none;
        }
        
        .tag-label span {
            margin-left: 8px;
            font-weight: bold;
            color: black;
        }
        
        .tag-label:hover {
            background-color: #f0f0f0;
            border-color: #716490; /* Hover border color */
        }
        
        .tag-label input:checked + span {
            background-color: #6f69a5; /* Checked background color */
            color: white;
            padding: 5px 10px;
            border-radius: 25px;
            transition: background-color 0.3s ease;
        }
        
        .review-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 11px;
            padding: 20px;
        }
        
        .review-categories .badge {
            background-color: #fdfdfd;
            color: #31273d;
            padding: 4px 10px;
            border-radius: 14px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            display: inline-block;
        }
        
        .review-categories .badge:hover {
            background-color: #f0f0f0;
            border: 3px solid #119c77;
            color: #119c77;
        }
        
        .review-categories .badge.selected {
            background-color: #6d618b;
            color: #e3d8ff;
            border: 2px solid transparent #119c77;
            glow: 2;
        }

        /* 돋보기 아이콘 */
        .search-btn {
            position: absolute;
            right: 16%;
            top: 25%;
            /* transform: translateY(-50%); */
            width: 20px;
            height: 24px;
            cursor: pointer;
        }
        
        .search-btn:hover {
            fill: #8B72B1; /* 호버 시 색상 변경 */
        }
        
        .search-bar {
            padding: 16px;
            border-radius: 19px;
            background-color: #464646;
            max-width: 1400px;
            border: none;
            color: #fff;
            margin: 30px 17% 30px auto;
            width: 70%;
        }

        /* 라디오 버튼과 이모티콘의 컨테이너 */
        .emoji-radio-container {
            display: flex;
            justify-content: space-evenly;
            margin-top: 37px;
            margin-right: 12px;
            margin-left: -30px;
        }
    
        /* 이모티콘 스타일 */
        .emoji-label {
            font-size: 50px;
            display: block;
            text-align: center;
            margin-bottom: 10px;
        }
    
        /* 라디오 버튼 기본 스타일 */
        .emoji-radio {
            display: block;
            margin: 0 auto;
            appearance: none; /* 기본 라디오 버튼 숨김 */
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid #f09eff;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
    
        /* 라디오 버튼 체크시 보라색으로 채우기 */
        .emoji-radio:checked {
            background-color: #fff;
        }
    
        /* 선택된 상태에서의 내부 동그라미 */
        .emoji-radio:checked::after {
            content: '';
            width: 20px;
            height: 20px;
            background-color: #6d4094;
            border-radius: 100%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            glow: 1;
    }

    /* 티어, 포지션 드롭다운 스타일 */
    .cute-dropdown {
        position: relative;
        display: inline-block;
        width: 150px; /* 드롭다운 너비 조정 */
        max-width: 200px;
        margin: 0 -30px; /* 드롭다운 간격 */
        margin-left: 10px;
    }

    /* 기본 화살표 제거 및 커스텀 스타일 적용 */
    .cute-dropdown select {
        -webkit-appearance: none; /* 사파리용 */
        -moz-appearance: none; /* 파이어폭스용 */
        appearance: none; /* 모든 브라우저에서 기본 화살표 제거 */
        width: 80%;
        padding: 16px 15px; /* 패딩을 더 넓게 */
        font-size: 16px; /* 글자 크기 조정 */
        font-weight: bold; /* 글자 굵기 */
        border: none; /* 테두리 없애기 */
        border-radius: 15px; /* 둥근 테두리 */
        background-color: #281b37; /* 어두운 배경색 */
        color: #f3f2f6; /* 밝은 텍스트 색상 */
        text-align: center; /* 가운데 정렬 */
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.1); /* 그림자 효과 */
        cursor: pointer;
    }

    .cute-dropdown select:hover {
        background-color: #49239E; /* 호버 시 배경색 변경 */
        glow: 1;
    }

    .cute-dropdown select:focus {
        outline: none;
        border-color: #8B72B1;
        box-shadow: 0 0 5px rgba(139, 114, 177, 0.5);
    }

    /* 티어, 포지션 */
    .form-group {
        display: block;
        text-align: left;
    }

    .left-body {
        display: flex;
        width: 100%;
        margin-right: 0px;
        margin-top: 0px;
    }

    .review-categories {
        gap: 14px;
        padding: 16px;
        margin-right: 50px;
    }

    .submit-btn {
        margin: 28px auto;
        /* margin-top: 40px; */
        padding: 11px 17px;
        background-color: #716490;
        color: white;
        border: none;
        border-radius: 22px;
        cursor: pointer;
        font-size: 15px;
        /* margin-left: 400px; */
    }

    /* 선호 스타일 입력 영역 스타일 */
    .preference-group {
        display: block;
        margin-top: 28px;
        margin-left: 10px;
    }

    .content-box {
        width: 100%;
        height: 120px;
        border-radius: 20px;
        background-color: #333;
        color: #dbe1ff;
        font-size: 17px;
        padding: 15px;
        border: none;
        resize: none;
        max-width: 1122px;
    }

    .preference-label {
        display: block;
        font-size: 18px;
        margin-bottom: -15px;
        margin-left: 16px;
        color: #b0b0b1;
    }

    submit-btn {
        margin-top: 40px;
        padding: 11px 17px;
        background-color: #716490;
        color: white;
        border: none;
        border-radius: 22px;
        cursor: pointer;
        font-size: 15px;
        align-content: center;
    }
    .search-bar {
        padding: 16px;
        border-radius: 19px;
        background-color: #464646;
        max-width: 1400px;
        border: none;
        color: #fff;
        margin: 30px auto 30px;
        width: 70%;
        align-content: center;
    }

    .left-container {
        width: 100%;
        margin-top: -10px;
        margin-bottom: 50px;
        margin-left: 90px;
        margin-right: 80px;
        text-align: center;
    }


</style>

{% endblock css %}

{% block content %}

<form id="articleForm" action="{% url 'articles' %}" method="POST" enctype="multipart/form-data">

    <!-- 1. 유저 검색 기능 -->
    <div class="user-search-container">
        <input type="text" id="user-search" class="search-bar" placeholder="유저 검색">
        <svg id="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="search-btn" fill="white">
            <path d="M10 2a8 8 0 105.29 14.29l4.63 4.63 1.41-1.41-4.63-4.63A8 8 0 0010 2zm0 2a6 6 0 110 12 6 6 0 010-12z"/>
        </svg>
    </div>
    

    {% csrf_token %}

    <form id="recommendation-form">
        {% csrf_token %}

        <div class="form-group">
            <div class="cute-dropdown">
                <select id="riot_tier" name="riot_tier">
                    <option value="" disabled selected>티어 선택</option>
                    <option value="bronze">브론즈</option>
                    <option value="silver">실버</option>
                    <option value="gold">골드</option>
                    <option value="platinum">플래티넘</option>
                    <option value="diamond">다이아몬드</option>
                    <option value="master">마스터</option>
                    <option value="grandmaster">그랜드마스터</option>
                    <option value="challenger">챌린저</option>
                </select>
            </div>
        
            <div class="cute-dropdown">
                <select id="riot_position" name="riot_position">
                    <option value="" disabled selected>포지션 선택</option>
                    <option value="top">탑</option>
                    <option value="jungle">정글</option>
                    <option value="mid">미드</option>
                    <option value="adc">원거리 딜러</option>
                    <option value="support">서포터</option>
                </select>
            </div>
        </div>



    <!-- 선호도 항목들 -->
    <div class="review-categories">
        <span class="badge" data-value="kindness">💗 상냥함</span>
        <span class="badge" data-value="teamwork">🛠 팀워크</span>
        <span class="badge" data-value="communication">📢 커뮤니케이션</span>
        <span class="badge" data-value="mental_strength">🧠 멘탈</span>
        <span class="badge" data-value="punctuality">⏰ 시간약속</span>
        <span class="badge" data-value="positivity">💪 긍정적</span>
        <span class="badge" data-value="mvp">⭐ MVP</span>
        <span class="badge" data-value="mechanical_skill">⚙️ 기계적</span>
        <span class="badge" data-value="operation">🎮 운영</span>
        <span class="badge" data-value="negativity">☹️ 부정적태도</span>
        <span class="badge" data-value="profanity">🤬 욕설</span>
        <span class="badge" data-value="afk">💤 탈주/자리비움</span>
        <span class="badge" data-value="cheating">🎮 치트</span>
        <span class="badge" data-value="verbal_abuse">😡 언어적폭력</span>
        <span class="badge" data-value="verbal_abuse">📌 기술</span>
        <span class="badge" data-value="verbal_abuse">🙈 피지컬</span>
        <span class="badge" data-value="verbal_abuse">🧍🏻 아들래미</span>
        <span class="badge" data-value="verbal_abuse">🧨 폭탄처리반</span>
        <span class="badge" data-value="verbal_abuse">🥰 목소리예쁨</span>
        <span class="badge" data-value="verbal_abuse">😂 웃김</span>
        <span class="badge" data-value="verbal_abuse">⛑️ 위기대처</span>
        <span class="badge" data-value="verbal_abuse">🤷🏻‍♂️ 목소리잘생김</span>
        <span class="badge" data-value="verbal_abuse">🙅‍♀️ 말예쁨게함</span>
    </div>
  
    <!-- 선호 스타일 -->
    <div class="form-group preference-group">
        <label for="user_preference" class="preference-label">선호하는 스타일 입력하기</label>
        <textarea id="content" name="content" class="content-box" placeholder="예: 목소리 예쁜 유저를 선호합니다.." required></textarea>
    </div>

    <input type="hidden" name="selected_categories" id="selected_categories">
    <input type="submit" value="❤️&nbsp나랑 맞는 유저 찾아줘&nbsp❤️" class="submit-btn">

    </form>

{% endblock content %}

{% block javascript%}

<script>


    // 1. 유저 검색 기능
    document.getElementById('search-icon').addEventListener('click', function () {
        const query = document.getElementById('user-search').value.trim(); // 검색어 트림 처리

        if (!query) {
            alert('검색어를 입력해주세요.');
            return;
        }

        fetch(`/api/articles/search_user/?q=${encodeURIComponent(query)}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'Authorization': 'Bearer ' + getAccessToken(), // 올바른 토큰 전달
            },
        })
            .then((response) => {
                if (response.status === 401) {
                    alert('인증이 필요합니다. 다시 로그인해주세요.');
                    window.location.href = '/login'; // 로그인 페이지로 리다이렉트
                    return;
                }
                return response.json();
            })
            .then((data) => {
                if (data && data.users.length === 1) {
                    const user = data.users[0];
                    window.location.href = `/${user.username}`; // 유저 상세 페이지로 이동
                } else {
                    alert('검색 결과가 없습니다.');
                }
            })
            .catch((error) => console.error('Error:', error));
    });

    
    // Bearer 토큰 가져오는 함수
    function getAccessToken() {
        return localStorage.getItem('access_token');
    }

    // CSRF 토큰을 가져오는 함수
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');


    // 1. 유저 검색 기능
    document.getElementById('search-icon').addEventListener('click', function() {
        const query = document.getElementById('user-search').value;
        const revieweeSelect = document.getElementById('reviewee');
        revieweeSelect.innerHTML = '<option value="">--평가 할 사람을 고르세요--</option>';

        fetch(`/api/articles/search_user/?q=${query}`, {
            method: 'GET', 
            headers: {
                'X-CSRFToken': csrftoken, 
                'Authorization': 'Bearer ' + getAccessToken() 
            }
            })
            .then(response => response.json())
            .then(data => {
                if (data.users.length === 0) {
                    return;
                }
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.textContent = `${user.username} | ${user.riot_username || ''}${user.riot_tag || ''}`;
                    option.value = user.id;
                    revieweeSelect.appendChild(option);
                });
            });
    });


    // 선호하는 스타일 체크하기 기능
    document.addEventListener('DOMContentLoaded', function() {
        const badges = document.querySelectorAll('.badge');
        const selectedCategoriesInput = document.getElementById('selected_categories');

        badges.forEach(badge => {
            badge.addEventListener('click', function() {
                // 선택된 뱃지에 'selected' 클래스 추가/제거
                this.classList.toggle('selected');
    
                // 선택된 카테고리를 hidden input에 업데이트
                const selectedCategories = Array.from(badges)
                    .filter(badge => badge.classList.contains('selected'))
                    .map(badge => badge.dataset.value);
                selectedCategoriesInput.value = selectedCategories.join(',');
            });
        });
    });


    document.getElementById('articleForm').addEventListener('submit', function (event) {
        event.preventDefault(); // 기본 폼 제출 동작 막기
    
        const revieweeSelect = document.getElementById('reviewee');
        const selectedCategories = document.getElementById('selected_categories').value;
    
        // 조건: 최소한 하나의 평가 대상이 선택되었는지 확인 (필요 시 수정)
        if (revieweeSelect && revieweeSelect.value === "") {
            alert("선호하는 게임 스타일이나 선호하는 유저의 성격을 선택해주세요💓"); // 경고 메시지 표시
            return;
        }
    
        // 매칭 결과 페이지로 리다이렉트
        window.location.href = '/matching_result/';
    });
    
</script>

{% endblock javascript %}
