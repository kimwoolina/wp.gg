{% extends "base.html" %}

{% block title %}title내용{% endblock title %}

{% block css %}
{% load static %}
<link rel="stylesheet" href="{% static '/css/rank.css' %}">
{% endblock css %}
{% block content %}

    <h1>유저 랭킹</h1>
    <div class="top-container">
        <div class="filter-container">
            <label for="positions">포지션 선택:</label>
            <select id="positions" multiple>
                <option value="top">탑</option>
                <option value="jungle">정글</option>
                <option value="mid">미드</option>
                <option value="adc">원딜</option>
                <option value="support">서포터</option>
            </select>

            <label for="sort_by">정렬 기준:</label>
            <select id="sort_by">
                <option value="score">점수</option>
                <option value="kindness">친절함</option>
                <option value="teamwork">팀워크</option>
                <option value="communication">소통</option>
                <option value="mental_strength">정신력</option>
                <option value="punctuality">성실함</option>
                <option value="positivity">긍정적</option>
                <option value="mvp">MVP</option>
                <option value="mechanical_skill">피지컬</option>
                <option value="operation">운영</option>
            </select>

            <button onclick="applyFilters()">필터 적용</button>
        </div>
    </div>

    <table id="ranking-table">
        <thead>
            <tr>
                <th>순위</th>
                <th>사용자 이름</th>
                <th>라이엇 사용자 이름</th>
                <th>라이엇 태그</th>
                <th>총점</th>
                <th>친절함</th>
                <th>팀워크</th>
                <th>소통</th>
                <th>정신력</th>
                <th>성실함</th>
                <th>긍정적</th>
                <th>MVP</th>
                <th>피지컬</th>
                <th>운영</th>
            </tr>
        </thead>
        <tbody>
            <!-- 데이터가 여기에 추가됩니다. -->
        </tbody>
    </table>
{% endblock content %}
{% block javascript %}
    <script>
        // 초기 데이터 로드
        function loadInitialData() {
            fetch('/api/profile/rankings/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Initial data:', data); // API 호출 결과 출력
                    renderTable(data); // 사용자 배열을 바로 전달
                })
                .catch(error => console.error('Error loading data:', error));
        }

        // 테이블 렌더링 함수
        function renderTable(users) {
            const tableBody = document.querySelector('#ranking-table tbody');
            tableBody.innerHTML = ''; // 기존 내용 초기화

            if (!users || users.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="18">해당 조건에 맞는 유저 정보가 없습니다.</td>';
                tableBody.appendChild(row);
                return;
            }

            users.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.username}</td>
                    <td>${user.riot_username || 'N/A'}</td>
                    <td>${user.riot_tag || 'N/A'}</td>
                    <td>${user.score}</td>
                    <td>${user.evaluations.kindness}</td>
                    <td>${user.evaluations.teamwork}</td>
                    <td>${user.evaluations.communication}</td>
                    <td>${user.evaluations.mental_strength}</td>
                    <td>${user.evaluations.punctuality}</td>
                    <td>${user.evaluations.positivity}</td>
                    <td>${user.evaluations.mvp}</td>
                    <td>${user.evaluations.mechanical_skill}</td>
                    <td>${user.evaluations.operation}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function getSelectedValues(selectElement) {
            const selectedOptions = Array.from(selectElement.options)
                .filter(option => option.selected)
                .map(option => option.value);
            return selectedOptions.join(',');
        }

        function applyFilters() {
            const positions = getSelectedValues(document.getElementById('positions'));
            const sortBy = document.getElementById('sort_by').value; // 선택한 정렬 기준 가져오기

            let url = '/api/profile/rankings/?';
            if (positions) {
                url += `positions=${positions}&`;
            }
            if (sortBy) {
                url += `sort_by=${sortBy}`;
            }

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Filtered data:', data); // 필터링된 결과 출력
                    renderTable(data); // 사용자 배열을 바로 전달
                })
                .catch(error => console.error('Error applying filters:', error));
        }

        // 페이지 로드 시 데이터 가져오기
        window.onload = loadInitialData;
    </script>
{% endblock javascript %}