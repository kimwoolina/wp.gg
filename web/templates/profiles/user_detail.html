{% extends "base.html" %}

{% block title %}ìœ ì €ê²€ìƒ‰{% endblock title %}    

{% block css %}
{% load static %}
<link rel="stylesheet" href="{% static '/css/user_detail.css' %}">
<style>
{% comment %} /* ìŠ¤í”¼ë„ˆ */ {% endcomment %}
.loader {
    width: 48px;
    height: 48px;
    border: 5px solid #FFF;
    border-bottom-color: transparent;
    border-radius: 50%;
    display: inline-block;
    box-sizing: border-box;
    animation: rotation 1s linear infinite;

    {% comment %} /* í™”ë©´ ì¤‘ì•™ì— ë°°ì¹˜ */ {% endcomment %}
    position: fixed; 
    top: 50%; 
    left: 55%; 
    transform: translate(-50%, -50%); 
}

@keyframes rotation {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}
</style>
{% endblock css%}

{% block content %}

<span class="loader" id="loader" style="display: none;"></span>
<div id="result" style="margin-top: 20px;"></div>


{% endblock content %}

{% block javascript%}

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìœ ì € ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        window.onload = function() {
            const pathParts = window.location.pathname.split('/');
            const username = pathParts[pathParts.length - 1]; // URLì—ì„œ ìœ ì € ì´ë¦„ ì¶”ì¶œ
            
            const urlParams = new URLSearchParams(window.location.search);
            const riotTag = urlParams.get('riot_tag'); // URLì—ì„œ Riot íƒœê·¸ ì¶”ì¶œ
            
            fetchUserData(username, riotTag);
        };

        // ìœ ì € ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        function fetchUserData(username, riotTag) {
            let apiUrl = `http://127.0.0.1:8000/api/profile/${username}`;
            if (riotTag) {
                apiUrl += `?riot_tag=${encodeURIComponent(riotTag)}`; // íƒœê·¸ê°€ ìˆì„ ê²½ìš° ì¶”ê°€
            }
            // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
            document.getElementById('loader').style.display = 'inline-block';
            // ì´ì „ ë‚´ìš© ì´ˆê¸°í™”
            document.getElementById('result').innerHTML = ''; 

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ìœ ì € ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('loader').style.display = 'none';
                    displayUserData(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    // alert('ìœ ì € ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); 
                    document.getElementById("result").innerText = 'ì†Œí™˜ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
                });
        }

        // ìœ ì € ë°ì´í„°ë¥¼ í˜ì´ì§€ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function displayUserData(data) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = ''; // ì´ì „ ë‚´ìš© ì´ˆê¸°í™”
            
            let score = Number(data.score.toFixed(2));
            resultDiv.innerHTML += `<div class="site-user-info"><h1>${data.username}</h1> <span class="total-score">ğŸ‘${score}</span></div><br>`; // ì‚¬ì´íŠ¸ ìœ ì €ë„¤ì„, ì ìˆ˜

            // ë¼ì´ì—‡ ì •ë³´ ìœ ë¬´ì— ë”°ë¥¸ í”„ë¡œí•„ êµì²´
            if(data.riot_info){
                resultDiv.innerHTML += `<div class="profile-level"><img id="profile-icon" src="${data.riot_info.profileIconLink}" alt="Profile Icon"/><span id="summoner-level">${data.riot_info.summonerLevel}</span><br>`;
                // resultDiv.innerHTML += `<span id="summoner-level">${data.riot_info.summonerLevel}</span>`
            }
            else {
                resultDiv.innerHTML += `<img id="profile-icon" src="${data.profile_image}" alt="Profile Icon"/>`;
            }
            
            // ìœ ì € ê¸°ë³¸ ì •ë³´
            if(data.riot_username && data.riot_tag){
                resultDiv.innerHTML += `<h2 class="riot_username_tag">${data.riot_username} | #${data.riot_tag}</h2>`;
            }
            else{
                resultDiv.innerHTML += `<h2 class="riot_username_tag">${data.riot_username || ''}#${data.riot_tag || ''}</h2>`;
            }
            
            // ë¼ì´ì—‡ ì •ë³´ ì¶œë ¥
            if (data.riot_info) {
                const leagueInfo = data.riot_info.league.map(league => {
                    return `${league.tier} ${league.rank} (${league.leaguePoints} LP) - Wins: ${league.wins}, Losses: ${league.losses}`;
                }).join('<br>');
                if(data.riot_info.preferredPosition != 'Invalid'){
                    resultDiv.innerHTML += `<p>Preferred Position: ${data.riot_info.preferredPosition}</p>`;
                }
                if(leagueInfo){
                    resultDiv.innerHTML += `<h2>League Info:</h2><div>${leagueInfo}</div>`;
                }
                
                
                // Top Champions ë°ì´í„° ìˆì„ ì‹œ ì¶œë ¥
                if(data.riot_info.topChampions){
                    resultDiv.innerHTML += `<h2>Top Champions</h2><span id="top-champions"></span>`;
                    const topChampionsDiv = document.getElementById('top-champions');
                    data.riot_info.topChampions.forEach(champion => {
                        topChampionsDiv.innerHTML += `
                        <div>
                            <p>${champion.championName}</p>
                            <img src="${champion.championImage}" alt="${champion.championName}" style="width: 50px; height: 50px;"/>
                            </div>
                            `;
                    });
                }  
            }
                else{
                    resultDiv.innerHTML += `<p>Riot Tier: ${data.riot_tier || 'ì •ë³´ ì—†ìŒ'} â€¢ í¬ì§€ì…˜ ë„£ì„ì˜ˆì •</p>`;
                }

            // Evaluations ì¶œë ¥
            if(data.articles != false){
                resultDiv.innerHTML += `<h2>Evaluations</h2><div id="evaluation-container"></div>`;
                const evaluationDiv = document.getElementById('evaluation-container');
            }
            if(data.evaluations.kindness){
                evaluationDiv.innerHTML +=`
                <div class="evaluation-item">ğŸ’—ìƒëƒ¥í•¨: ${data.evaluations.kindness} </div>
                `;
            }
            if(data.evaluations.teamwork){
                evaluationDiv.innerHTML +=`
                <div class="evaluation-item">ğŸ™ŒğŸ»íŒ€ì›Œí¬: ${data.evaluations.teamwork} </div>
                `;
            }
            if(data.evaluations.communication){
                evaluationDiv.innerHTML +=`
                <div class="evaluation-item">ğŸ¤ì†Œí†µ: ${data.evaluations.communication} </div>
                `;
            }
            if(data.evaluations.mental_strength){
                evaluationDiv.innerHTML +=`
                <div class="evaluation-item">ğŸ˜‡ë©˜íƒˆ ê´€ë¦¬: ${data.evaluations.mental_strength} </div>
                `;
            }
            if(data.evaluations.punctuality){
                evaluationDiv.innerHTML +=`
                <div class="evaluation-item">â±ì‹œê°„ì•½ì†: ${data.evaluations.punctuality} </div>
                `;
            }
            if(data.evaluations.positivity){
                evaluationDiv.innerHTML +=`
                <div class="evaluation-item">ğŸŒˆê¸ì •ì : ${data.evaluations.positivity} </div>
                `;
            }
            if(data.evaluations.mvp){
                evaluationDiv.innerHTML +=`
                <div class="evaluation-item">ğŸ‘‘MVP: ${data.evaluations.mvp} </div>
                `;
            }
            if(data.evaluations.mechanical_skill){
                evaluationDiv.innerHTML +=`
                <div class="evaluation-item">ğŸ’ªí”¼ì§€ì»¬: ${data.evaluations.mechanical_skill} </div>
                `;
            }
            if(data.evaluations.operation){
                evaluationDiv.innerHTML +=`
                <div class="evaluation-item">ğŸ§ ìš´ì˜ ëŠ¥ë ¥: ${data.evaluations.operation} </div>
                `;
            }
            if(data.evaluations.negativity){
                evaluationDiv.innerHTML +=`
                <div class="evaluation-item">ğŸ™ë¶€ì •ì  íƒœë„: ${data.evaluations.negativity} </div>
                `;
            }
            if(data.evaluations.profanity){
                evaluationDiv.innerHTML +=`
                <div class="evaluation-item">ğŸ¤¬ìš•ì„¤: ${data.evaluations.profanity} </div>
                `;
            }
            if(data.evaluations.afk){
                evaluationDiv.innerHTML +=`
                <div class="evaluation-item">â“íƒˆì£¼/ìë¦¬ë¹„ì›€: ${data.evaluations.afk} </div>
                `;
            }
            if(data.evaluations.cheating){
                evaluationDiv.innerHTML +=`
                <div class="evaluation-item">ğŸ¥·ë¶€ì •í–‰ìœ„: ${data.evaluations.cheating} </div>
                `;
            }
            if(data.evaluations.verbal_abuse){
                evaluationDiv.innerHTML +=`
                <div class="evaluation-item">ğŸ˜¡ê³µê²©ì ì¸ì–¸í–‰: ${data.evaluations.verbal_abuse}</div>
                `;
            }

            // Articles ì¶œë ¥
            resultDiv.innerHTML += `<h2>Articles</h2><div id="articles"></div>`;
            if(data.articles != false){
                console.log(data.articles)
                const articlesDiv = document.getElementById('articles');
                data.articles.forEach(article => {
                    articlesDiv.innerHTML += `
                        <div class="article">
                            <div class="title-score">
                                <h3 class="title">${article.title}</h3>
                                <span class="article-score">ğŸ‘${article.article_score}</span>
                            </div>
                            <div class="created-at">${new Date(article.created_at).toLocaleString()}</div>
                        </div>
                    `;
                });
                resultDiv.appendChild(articlesDiv);
            }
            else{
                articles.innerHTML += `<h3 style="color: gray;">ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</h3>`
            }
        }
    </script>

{% endblock javascript %}
