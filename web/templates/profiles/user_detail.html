{% extends "base.html" %}

{% block title %}유저검색{% endblock title %}    

{% block css %}
{% load static %}
<link rel="stylesheet" href="{% static '/css/user_detail.css' %}">
<style>
{% comment %} /* 스피너 */ {% endcomment %}
.loader {
    width: 48px;
    height: 48px;
    border: 5px solid #FFF;
    border-bottom-color: transparent;
    border-radius: 50%;
    display: inline-block;
    box-sizing: border-box;
    animation: rotation 1s linear infinite;

    {% comment %} /* 화면 중앙에 배치 */ {% endcomment %}
    position: fixed; 
    top: 50%; 
    left: 55%; 
    transform: translate(-50%, -50%); 
}

@keyframes rotation {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}
</style>
{% endblock css%}

{% block content %}

<span class="loader" id="loader" style="display: none;"></span>
<div id="result" style="margin-top: 20px;"></div>


{% endblock content %}

{% block javascript%}

    <script>
        // 페이지 로드 시 유저 정보를 가져오는 함수
        window.onload = function() {
            const pathParts = window.location.pathname.split('/');
            const username = pathParts[pathParts.length - 1]; // URL에서 유저 이름 추출
            
            const urlParams = new URLSearchParams(window.location.search);
            const riotTag = urlParams.get('riot_tag'); // URL에서 Riot 태그 추출
            
            fetchUserData(username, riotTag);
        };

        // 유저 데이터를 가져오는 함수
        function fetchUserData(username, riotTag) {
            let apiUrl = `http://127.0.0.1:8000/api/profile/${username}`;
            if (riotTag) {
                apiUrl += `?riot_tag=${encodeURIComponent(riotTag)}`; // 태그가 있을 경우 추가
            }
            // 로딩 스피너 표시
            document.getElementById('loader').style.display = 'inline-block';
            // 이전 내용 초기화
            document.getElementById('result').innerHTML = ''; 

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('유저 정보를 가져오는 데 실패했습니다.');
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('loader').style.display = 'none';
                    displayUserData(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    // alert('유저 정보를 가져오는 데 문제가 발생했습니다.'); 
                    document.getElementById("result").innerText = '소환사 정보를 찾을 수 없습니다.'
                });
        }

        // 유저 데이터를 페이지에 표시하는 함수
        function displayUserData(data) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = ''; // 이전 내용 초기화
            
            let score = Number(data.score.toFixed(2));
            resultDiv.innerHTML += `<div class="site-user-info"><h1>${data.username}</h1> <span class="score">👍${score}</span><br>`; // 사이트 유저네임, 점수

            // 라이엇 정보 유무에 따른 프로필 교체
            if(data.riot_info){
                resultDiv.innerHTML += `<img id="profile-icon" src="${data.riot_info.profileIconLink}" alt="Profile Icon" style="width: 100px; " /><br>`;
                resultDiv.innerHTML += `<span id="summoner-level">${data.riot_info.summonerLevel}</span>`
            }
            else {
                resultDiv.innerHTML += `<img id="profile-icon" src="${data.profile_image}" alt="Profile Icon" style="width: 100px; " />`;
            }
            
            // 유저 기본 정보
            if(data.riot_username && data.riot_tag){
                resultDiv.innerHTML += `<p class="riot_username_tag">${data.riot_username} | #${data.riot_tag}</p>`;
            }
            else{
                resultDiv.innerHTML += `<p class="riot_username_tag">${data.riot_username || ''}#${data.riot_tag || ''}</p>`;
            }
            
            // 라이엇 정보 출력
            if (data.riot_info) {
                const leagueInfo = data.riot_info.league.map(league => {
                    return `${league.tier} ${league.rank} (${league.leaguePoints} LP) - Wins: ${league.wins}, Losses: ${league.losses}`;
                }).join('<br>');
                resultDiv.innerHTML += `<p>Preferred Position: ${data.riot_info.preferredPosition}</p>`;
                resultDiv.innerHTML += `<h2>League Info:</h2><div>${leagueInfo}</div>`;
                
                
                // Top Champions 출력
                resultDiv.innerHTML += `<h2>Top Champions</h2><span id="top-champions"></span>`;
                const topChampionsDiv = document.getElementById('top-champions');
                data.riot_info.topChampions.forEach(champion => {
                    topChampionsDiv.innerHTML += `
                    <div>
                        <p>${champion.championName}</p>
                        <img src="${champion.championImage}" alt="${champion.championName}" style="width: 50px; height: 50px;"/>
                        </div>
                        `;
                    });
                }
                else{
                    resultDiv.innerHTML += `<p>Riot Tier: ${data.riot_tier || '정보 없음'} • 포지션 넣을예정</p>`;
                }

            // Evaluations 출력
            resultDiv.innerHTML += `<h2>Evaluations</h2>`;
            resultDiv.innerHTML += `
                <div>
                    💗상냥함: ${data.evaluations.kindness} 
                    🙌🏻팀워크: ${data.evaluations.teamwork} 
                    🤝소통: ${data.evaluations.communication} 
                    😇멘탈 관리: ${data.evaluations.mental_strength} 
                    ⏱시간약속: ${data.evaluations.punctuality} 
                    🌈긍정적: ${data.evaluations.positivity} 
                    👑MVP: ${data.evaluations.mvp} 
                    💪피지컬: ${data.evaluations.mechanical_skill} 
                    🧠운영 능력: ${data.evaluations.operation} 
                    🙁부정적 태도: ${data.evaluations.negativity} 
                    🤬욕설: ${data.evaluations.profanity} 
                    ❓탈주/자리비움: ${data.evaluations.afk} 
                    🥷부정행위: ${data.evaluations.cheating} 
                    😡공격적인언행: ${data.evaluations.verbal_abuse}
                </div>
            `;

            // Articles 출력
            resultDiv.innerHTML += `<h2>Articles</h2>`;
            const articlesDiv = document.createElement('div');
            data.articles.forEach(article => {
                articlesDiv.innerHTML += `
                    <div>
                        <h3>${article.title}</h3>
                        <p>Score: ${article.article_score}</p>
                        <p>Created At: ${new Date(article.created_at).toLocaleString()}</p>
                    </div>
                `;
            });
            resultDiv.appendChild(articlesDiv);
        }
    </script>

{% endblock javascript %}
